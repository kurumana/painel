<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesquisa Local</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
            background: url('M://Cadastro//Núcleo Suprimentos//Núcleo de Materiais//Arquivos Atalho//img//background.png') no-repeat center center fixed;
        }

        .container {
            max-width: 80%;
            margin: auto;
            padding: 20px;
            background-color: transparent;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            color: #ffffff;
        }

        input,
        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            font-size: 16px;
            border: 1px solid #ffffff;
            border-radius: 5px;
        }

        input:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
            outline: none;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        .btn-search {
            width: 20%;
            /* Define a largura menor */
            padding: 10px;
            /* Ajusta o espaçamento interno */
            font-size: 18px;
            /* Diminui o tamanho da fonte */
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px auto;
            /* Adiciona espaço e centraliza */
            display: block;
            /* Necessário para o margin auto funcionar */
            text-align: center;
        }

        .btn-search:hover {
            background-color: #0056b3;
            /* Cor ao passar o mouse */
        }

        button:hover {
            background-color: #0056b3;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #ffffff;
        }

        .table th,
        .table td {
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .table th {
            background-color: #f1f1f1;
            text-transform: uppercase;
        }

        .alert {
            padding: 10px;
            background-color: #ffdddd;
            color: red;
            margin-top: 20px;
            border-left: 5px solid red;
        }

        nav {
            width: 100%;
            background-color: #333;
            padding: 5px 0; /* Reduzido de 10px para 5px */
            margin-bottom: 15px; /* Reduzido de 20px para 15px */
            height: auto;
        }

        nav ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            gap: 15px; /* Reduzido de 20px para 15px */
        }

        nav ul li a,
        .dropdown-btn {
            padding: 6px 14px; /* Reduzido de 8px 16px */
            border-radius: 4px;
            transition: background-color 0.3s;
            color: white;
            text-decoration: none;
            display: inline-block;
            line-height: normal;
        }

        nav ul li a:hover,
        .dropdown:hover .dropdown-btn {
            background-color: #111;
        }

        .dropdown {
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .badge {
            background-color: red;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 10px;
            margin-left: 5px;
            vertical-align: top;
        }

        h1 {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin: 30px auto;
            padding: 15px 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: fit-content;
            max-width: 90%;
        }
    </style>
</head>

<body>
    <script src="js/nav.js"></script>
    <h1>Pesquisa Local</h1>
    <div class="container">
        <div class="header">
        </div>
        <!-- Formulário de upload e pesquisa -->
        <div class="form-row">
            <div class="form-group">
                <label for="fileInput">Selecione a Planilha:</label>
                <input type="file" id="fileInput" class="form-control" accept=".xlsx, .xls">
            </div>
            <div class="form-group">
                <label for="query">Pesquisa:</label>
                <input type="text" id="query" class="form-control search-box"
                    placeholder="Consultar por Descrição, Referência ou Anvisa..." disabled>
            </div>
            <div class="form-group">
                <button id="searchButton" class="btn-search">Pesquisar</button>
            </div>
            <div class="form-group">
                <button id="downloadButton" class="btn btn-success" style="display: none;">Baixar Resultados</button>
            </div>
        </div>

        <!-- Alerta de resultado não encontrado -->
        <div id="alert" class="alert alert-warning mt-4" role="alert" style="display: none;">
            Nenhum resultado encontrado.
        </div>

        <!-- Tabela de resultados -->
        <table id="resultsTable" class="table table-striped mt-4">
            <thead>
                <tr>
                    <th>Tasy</th>
                    <th>Descrição</th>
                    <th>Referênca</th>
                    <th>Fabricante</th>
                    <th>Anvisa</th>
                    <th>Validade</th>
                    <th>Consignado</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <script>
        let excelData = []; // Armazena os dados da planilha
        let filteredData = []; // Armazena os resultados filtrados
        let currentSortColumn = null; // Coluna atualmente ordenada
        let currentSortDirection = 'asc'; // Direção atual (ascendente ou descendente)

        // Manipular upload de arquivo
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Ler a primeira aba do Excel
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

                // Converter os dados da aba para JSON
                excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                // Habilitar a pesquisa
                document.getElementById('query').disabled = false;
                document.getElementById('searchButton').disabled = false;

                alert("Planilha carregada com sucesso!");
            };

            reader.readAsArrayBuffer(file);
        });

        // Função para realizar a pesquisa
        function performSearch() {
            const query = document.getElementById('query').value.toLowerCase();
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = ''; // Limpar resultados anteriores
            const alert = document.getElementById('alert');
            const downloadButton = document.getElementById('downloadButton');
            alert.style.display = 'none'; // Esconder alerta
            downloadButton.style.display = 'none'; // Esconder botão de download

            // Filtrar os dados com base nas colunas 2, 3, 5 e 7
            filteredData = excelData.filter((row, index) => {
                // Ignorar o cabeçalho (index === 0) ou linhas vazias
                if (index === 0 || row.length === 0) return false;

                return (
                    (row[1] && row[1].toString().toLowerCase().includes(query)) || // Coluna 2
                    (row[2] && row[2].toString().toLowerCase().includes(query)) || // Coluna 3
                    (row[4] && row[4].toString().toLowerCase().includes(query)) || // Coluna 7
                    (row[6] && row[6].toString().toLowerCase().includes(query))    // Coluna 5
                );
            });

            renderTable(filteredData);

            if (filteredData.length === 0) {
                alert.style.display = 'block'; // Exibir alerta se não encontrar resultados
            } else {
                downloadButton.style.display = 'block'; // Mostrar botão de download
            }
        }

        // Função para renderizar a tabela
        function renderTable(data) {
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = ''; // Limpar resultados anteriores

            data.forEach(row => {
                const tr = document.createElement('tr');
                const col5Value = row[4] || '';
                const col6Value = row[5] || '';
                const isDifferent = col5Value !== col6Value;

                tr.innerHTML = `
                    <td>${row[0] || ''}</td>
                    <td>${row[1] || ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>${row[3] || ''}</td>
                    <td>${col5Value}</td>
                    <td>${col6Value}</td>
                    <td>${row[6] || ''}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Função para ordenar a tabela
        function sortTable(columnIndex) {
            // Alternar a direção de ordenação
            if (currentSortColumn === columnIndex) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnIndex;
                currentSortDirection = 'asc';
            }

            // Ordenar os dados filtrados
            filteredData.sort((a, b) => {
                const valueA = (a[columnIndex] || '').toString().toLowerCase();
                const valueB = (b[columnIndex] || '').toString().toLowerCase();

                if (valueA < valueB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Re-renderizar a tabela
            renderTable(filteredData);
        }

        // Função para baixar os resultados filtrados
        function downloadResults() {
            const ws = XLSX.utils.aoa_to_sheet(filteredData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Resultados');
            XLSX.writeFile(wb, 'resultados_filtrados.xlsx');
        }

        // Event listeners para botões
        document.getElementById('searchButton').addEventListener('click', performSearch);
        document.getElementById('query').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') performSearch();
        });
        document.getElementById('downloadButton').addEventListener('click', downloadResults);

        // Event listeners para classificação ao clicar nos cabeçalhos
        document.querySelectorAll('#resultsTable th').forEach((th, index) => {
            th.addEventListener('click', () => sortTable(index));
        });
    </script>

    <!-- Bootstrap JS (opcional para funcionalidade extra) -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <script src="js/script.js"></script>

</body>

</html>